{"version":3,"sources":["../src/deploy.js"],"names":["require","fs","globby","scrolex","persistOpts","announce","addCommandAsComponent","components","main","module","failure","process","argv","exit","exports","runtime","cb","onTravis","ghPagesEnv","GHPAGES_BOTNAME","stick","exe","cwd","contentBuildDir","GHPAGES_BOTEMAIL","GHPAGES_URL","Error","sync","length","existsSync","writeFileSync"],"mappings":"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","file":"deploy.js","sourcesContent":["require('babel-polyfill')\nconst fs      = require('fs')\nconst globby  = require('globby')\nconst scrolex = require('scrolex').persistOpts({\n  announce             : true,\n  addCommandAsComponent: true,\n  components           : `lanyon>deploy`,\n})\n\nif (require.main === module) {\n  scrolex.failure(`Please only used this module via require, or: src/cli.js ${process.argv[1]}`)\n  process.exit(1)\n}\n\nmodule.exports = async (runtime, cb) => {\n  if (runtime.onTravis) {\n    if (runtime.ghPagesEnv.GHPAGES_BOTNAME) {\n      scrolex.stick('Setting up GHPAGES_BOTNAME')\n      await scrolex.exe(`git config --global user.name \"${runtime.ghPagesEnv.GHPAGES_BOTNAME}\"`, { cwd: runtime.contentBuildDir })\n    }\n    if (runtime.ghPagesEnv.GHPAGES_BOTEMAIL) {\n      scrolex.stick('Setting up GHPAGES_BOTNAME')\n      await scrolex.exe(`git config --global user.email \"${runtime.ghPagesEnv.GHPAGES_BOTEMAIL}\"`, { cwd: runtime.contentBuildDir })\n    }\n  }\n\n  if (!runtime.ghPagesEnv.GHPAGES_URL) {\n    return cb(new Error('GHPAGES_URL was not set. Did you source env.sh? Did you encrypt it with Travis?'))\n  }\n\n  if (!globby.sync(`${runtime.contentBuildDir}/assets/build/app*.js`).length) {\n    return cb(new Error(`I refuse to deploy if there is no ${runtime.contentBuildDir}/assets/build/app*.js - build:production first!`))\n  }\n  if (fs.existsSync(`${runtime.contentBuildDir}/env.sh`)) {\n    return cb(new Error(`I refuse to deploy if while ${runtime.contentBuildDir}/env.sh exists - secure your build first!`))\n  }\n  if (!fs.existsSync(`${runtime.contentBuildDir}/.git`)) {\n    await scrolex.exe('git init', { cwd: runtime.contentBuildDir })\n  }\n\n  fs.writeFileSync(`${runtime.contentBuildDir}/README.md`, 'This branch is just a deploy target. Do not edit. You changes will be lost.', 'utf-8')\n  await scrolex.exe('git checkout -B gh-pages', { cwd: runtime.contentBuildDir })\n  await scrolex.exe('git add --all .', { cwd: runtime.contentBuildDir })\n  await scrolex.exe('git commit -nm \"Update website by $USER\" || true', { cwd: runtime.contentBuildDir })\n  await scrolex.exe(`git remote add origin ${runtime.ghPagesEnv.GHPAGES_URL} 2> /dev/null || true`, { cwd: runtime.contentBuildDir })\n  // required to update the token:\n  await scrolex.exe(`git remote set-url origin ${runtime.ghPagesEnv.GHPAGES_URL}`, { cwd: runtime.contentBuildDir })\n  await scrolex.exe('git push origin gh-pages:refs/heads/gh-pages 2> /dev/null || git push origin gh-pages:refs/heads/gh-pages --force > /dev/null', { cwd: runtime.contentBuildDir })\n  cb(null)\n}\n"]}